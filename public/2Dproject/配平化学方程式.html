<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>化学方程式配平（高斯消元法）</title>
    <style>
        :root {
            --bg-1: rgb(235 242 255);
            --bg-2: rgb(210 225 255);

            --primary: rgb(70 120 220);
            --primary-strong: rgb(55 100 200);

            --card-bg: rgb(255 255 255 / 0.9);
            --card-bg-hover: rgb(255 255 255);

            --shadow-sm: 0 2px 6px rgb(0 0 0 / 0.12);
            --shadow-md: 0 6px 14px rgb(0 0 0 / 0.18);
        }

        html,
        body {
            margin: 0;
            padding: 0;
            min-height: 100%;
        }

        body {
            background: linear-gradient(to right, var(--bg-1), var(--bg-2));
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: rgb(0 0 0 / 0.85);
        }

        /* ===== Header ===== */

        header {
            margin: 0;
            position: sticky;
            top: 0;
            z-index: 100;

            padding: 10px;

            background-color: var(--primary);
            border-radius: 10px;
            box-shadow: var(--shadow-sm);

            font-size: 24px;
            font-weight: 500;

            transition:
                background-color 0.2s ease,
                box-shadow 0.2s ease,
                color 0.2s ease;
        }

        header:hover {
            background-color: var(--primary-strong);
            box-shadow: var(--shadow-md);
            color: rgb(24 24 24);
        }

        /* ===== Cards ===== */

        .card {
            margin: 20px 1vw;
            padding: 0 1vw;

            background-color: var(--card-bg);
            border-radius: 10px;
            border: 1px solid rgb(204 204 204 / 0.3);
            box-shadow: var(--shadow-sm);

            transition:
                background-color 0.2s ease,
                box-shadow 0.2s ease;
        }

        .card:hover {
            background-color: var(--card-bg-hover);
            box-shadow: var(--shadow-md);
        }

        /* ===== Typography ===== */

        p>code,
        pre {
            font-family: "Courier New", Courier, monospace;
        }

        p>code {
            background-color: rgb(207 207 207 / 0.3);
            padding: 2px 4px;
            border-radius: 4px;
        }

        pre {
            padding: 10px;
            margin: 10px;
            border-radius: 6px;
            overflow-x: auto;
            background-color: rgb(240 240 240 / 0.6);
        }

        button {
            margin-left: 10px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--primary);
            color: white;
            font-size: 16px;
            cursor: pointer;

            transition:
                background-color 0.2s ease,
                box-shadow 0.2s ease;
        }

        div{
            display: flex;
            align-items: center;
        }

        input {
            height: 30px;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid rgb(180 180 180);
            border-radius: 4px;
            font-size: 16px;
        }

        /* ===== Links ===== */

        a {
            color: #0044b1;
            text-decoration: none;

            background-image: linear-gradient(currentColor, currentColor);
            background-size: 0% 2px;
            background-position: 0 100%;
            background-repeat: no-repeat;

            transition: background-size 0.25s ease;
        }

        a:hover {
            background-size: 100% 2px;
        }

        /* ===== Comments ===== */

        .comment-card {
            padding: 10px;
            margin-bottom: 10px;

            background-color: rgb(255 255 255 / 0.8);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);

            transition:
                transform 0.15s ease,
                background-color 0.15s ease;
        }

        .comment-card:hover {
            transform: translateY(-2px);
            background-color: rgb(255 255 255 / 0.95);
        }
    </style>
</head>

<body>

    <header>化学方程式配平（高斯消元）</header>

    <div class="card">
        <input id="eq" value="Fe + O2 = Fe2O3">
        <button onclick="balance()">配平</button>
    </div>


    <pre id="out">wait for input</pre>

    <script>
        // ===== Fraction 类 =====
        class Fraction {
            constructor(n, d = 1) {
                if (d < 0) n = -n, d = -d;
                const g = Fraction.gcd(Math.abs(n), d);
                this.n = n / g;
                this.d = d / g;
            }
            static gcd(a, b) {
                while (b) [a, b] = [b, a % b];
                return a;
            }
            add(f) { return new Fraction(this.n * f.d + f.n * this.d, this.d * f.d); }
            sub(f) { return new Fraction(this.n * f.d - f.n * this.d, this.d * f.d); }
            mul(f) { return new Fraction(this.n * f.n, this.d * f.d); }
            div(f) { return new Fraction(this.n * f.d, this.d * f.n); }
            neg() { return new Fraction(-this.n, this.d); }
        }

        // ===== 化学式解析（无括号）=====
        function parseFormula(s) {
            const re = /([A-Z][a-z]*)(\d*)/g;
            let m, map = {};
            while (m = re.exec(s)) {
                const el = m[1];
                const cnt = m[2] ? parseInt(m[2]) : 1;
                map[el] = (map[el] || 0) + cnt;
            }
            return map;
        }

        // ===== 高斯消元 =====
        function gauss(mat, b) {
            const n = mat.length;
            const m = mat[0].length;

            for (let col = 0, row = 0; col < m && row < n; col++) {
                let sel = row;
                for (let i = row; i < n; i++) {
                    if (mat[i][col].n !== 0) { sel = i; break; }
                }
                if (mat[sel][col].n === 0) continue;

                [mat[row], mat[sel]] = [mat[sel], mat[row]];
                [b[row], b[sel]] = [b[sel], b[row]];

                const inv = mat[row][col];
                for (let j = col; j < m; j++)
                    mat[row][j] = mat[row][j].div(inv);
                b[row] = b[row].div(inv);

                for (let i = 0; i < n; i++) {
                    if (i !== row && mat[i][col].n !== 0) {
                        const factor = mat[i][col];
                        for (let j = col; j < m; j++)
                            mat[i][j] = mat[i][j].sub(factor.mul(mat[row][j]));
                        b[i] = b[i].sub(factor.mul(b[row]));
                    }
                }
                row++;
            }
            return b;
        }

        // ===== 主流程 =====
        function balance() {
            const eq = document.getElementById("eq").value;
            const [L, R] = eq.split("=");
            const left = L.split("+").map(s => s.trim());
            const right = R.split("+").map(s => s.trim());

            const all = left.concat(right);
            const signs = all.map((_, i) => i < left.length ? 1 : -1);

            const parsed = all.map(parseFormula);
            const elements = [...new Set(parsed.flatMap(o => Object.keys(o)))];

            const vars = all.length;
            const rows = elements.length;

            // 构建矩阵
            let A = [];
            let B = [];

            for (let e of elements) {
                let row = [];
                for (let i = 0; i < vars - 1; i++) {
                    row.push(new Fraction((parsed[i][e] || 0) * signs[i]));
                }
                const last = (parsed[vars - 1][e] || 0) * signs[vars - 1];
                B.push(new Fraction(-last));
                A.push(row);
            }

            // 解 Ax = B
            const sol = gauss(A, B);

            // x_n = 1
            let coeffs = sol.concat([new Fraction(1)]);

            // 通分
            const lcm = coeffs.reduce((a, f) => a * f.d / Fraction.gcd(a, f.d), 1);
            const ints = coeffs.map(f => f.n * (lcm / f.d));

            // 输出
            let res = "";
            for (let i = 0; i < left.length; i++)
                res += (ints[i] == '1' ? '' : ints[i]) + left[i] + " + ";
            res = res.slice(0, -3) + " = ";
            for (let i = 0; i < right.length; i++)
                res += (ints[i + left.length] == '1' ? '' : ints[i + left.length]) + right[i] + " + ";
            res = res.slice(0, -3);

            document.getElementById("out").textContent = res;
        }
    </script>

</body>

</html>