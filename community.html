<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="icon" href="https://songlll.pages.dev/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>犇犇社区</title>
    <link rel="stylesheet" href="https://songlll.pages.dev/web.css">
    <style>

        header #name {
            font-size: 18px;
        }

        #start {
            display: none;
        }

        #comment {
            display: none;
        }

        body::-webkit-scrollbar {
            width: 0px;
            /* 滚动条宽度 */
        }
    </style>
</head>

<body>
    <header>
        <div id="name">
            <loader></loader>加载中……
        </div>
        <button onclick="exit()">退出登录</button>
    </header>
    <div>
        <br>
    </div>
    <div id="start">
        <div class="bg" id="register">
            <h2>注册</h2>
            <input type="text" id="regName" placeholder="用户名">
            <input type="password" id="regPassword" placeholder="密码">
            <input type="text" id="regKey" placeholder="邀请码">
            <button onclick="register()">注册</button>
            <p id="regMsg"></p>
        </div>

        <div class="bg" id="login">
            <h2>登录</h2>
            <input type="text" id="loginName" placeholder="用户名">
            <input type="password" id="loginPassword" placeholder="密码">
            <button onclick="login()">登录</button>
            <p id="loginMsg"></p>
        </div>
    </div>
    <div id="comments" class="bg" style="display:none;">
        <h2>发表评论</h2>
        <textarea id="commentContent" placeholder="输入评论（最多500字）"></textarea>
        <button onclick="postComment()">发送</button>

    </div>
    <div class="bg" id="fcommentMsg" style="display: none;">
        <h1 id="commentMsg"></h1>
    </div>
    <div class="bg">
        <h2>评论列表</h2>
        <div id="commentList"></div>
    </div>

    <script>
        const API_BASE = "https://ljrfkrxwkqnruheucstl.supabase.co/functions/v1/songlllEdgeService";
        let token = null;

        // --- 注册 ---
        async function register() {
            const name = document.getElementById("regName").value;
            const password = document.getElementById("regPassword").value;
            const key = document.getElementById("regKey").value;
            const res = await fetch(`${API_BASE}/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, password, key })
            });
            const data = await res.json();
            document.getElementById("regMsg").textContent = data.error || data.message;
            document.getElementById("regMsg").className = data.error ? "error" : "success";
            setTimeout(() => {
                document.getElementById("regMsg").textContent = "";
            }, 5000);
        }

        // --- 登录 ---
        async function login() {
            const name = document.getElementById("loginName").value;
            const password = document.getElementById("loginPassword").value;
            const res = await fetch(`${API_BASE}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, password })
            });
            const data = await res.json();
            if (data.token) {
                token = data.token;
                document.getElementById("loginMsg").textContent = "登录成功";
                document.getElementById("loginMsg").className = "success";
                document.getElementById("comments").style.display = "block";
                loadComments();
                localStorage.setItem("token", token);
                document.getElementById("start").style.display = "none";
                document.getElementById("name").textContent = name;
            } else {
                document.getElementById("loginMsg").textContent = data.error;
                document.getElementById("loginMsg").className = "error";
            }
        }

        // --- 发评论 ---
        async function postComment() {
            const token = localStorage.getItem("token") || "";
            const content = document.getElementById("commentContent").value;

            try {
                const res = await fetch("https://songllluv-edgemockser-41.deno.dev/postComment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token, content })
                });
                const data = await res.json();

                document.getElementById("commentMsg").textContent = data.error || data.message;
                document.getElementById("commentMsg").className = data.error ? "error" : "success";

                if (!data.error) {
                    document.getElementById("commentContent").value = "";
                    loadComments();
                }
            } catch (err) {
                console.error("提交评论失败:", err);
                document.getElementById("commentMsg").textContent = "网络错误，请稍后再试";
                document.getElementById("commentMsg").className = "error";
            }
            document.getElementById("fcommentMsg").style.display = "block";
            setTimeout(() => {
                document.getElementById("fcommentMsg").style.display = "none";
                document.getElementById("commentMsg").textContent = "";
            }, 5000);
        }


        // --- 获取评论 ---
        async function loadComments() {
            const res = await fetch(`${API_BASE}/getComments`);
            const data = await res.json();
            const listDiv = document.getElementById("commentList");
            listDiv.innerHTML = "";

            data.forEach(c => {
                const div = document.createElement("div");
                div.className = "comment";

                const MAX_LEN = 100; // 超过 100 字折叠
                let shortContent = c.content;
                let isLong = false;

                if (c.content.length > MAX_LEN) {
                    shortContent = c.content.slice(0, MAX_LEN) + "...";
                    isLong = true;
                }

                div.innerHTML = `
            <span class="comment-name">${c.name}</span>: 
            <span class="comment-content">${shortContent}</span>
            ${isLong ? `<button class="toggle-btn">展开</button>` : ""}
        `;

                if (isLong) {
                    const btn = div.querySelector(".toggle-btn");
                    const contentSpan = div.querySelector(".comment-content");

                    btn.addEventListener("click", () => {
                        if (btn.textContent === "展开") {
                            contentSpan.textContent = c.content;
                            btn.textContent = "收起";
                        } else {
                            contentSpan.textContent = shortContent;
                            btn.textContent = "展开";
                        }
                    });
                }

                listDiv.appendChild(div);
            });
        }


        function exit() {
            localStorage.removeItem("token");
            location.reload();
        }

        // 自动加载评论
        loadComments();
    </script>

    <script>
        const localToken = localStorage.getItem("token") || "";
        fetch("https://songllluv-edgemockser-41.deno.dev/me", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: localToken })
        })
            .then(res => res.json())
            .then(data => {
                document.getElementById("name").textContent = data.name || "犇犇社区";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("name").textContent = "犇犇社区";
            }).then(() => {
                if (document.getElementById("name").textContent == "犇犇社区") {
                    document.getElementById("start").style.display = "block";
                    document.getElementById("comments").style.display = "none";
                }
                else {
                    document.getElementById("start").style.display = "none";
                    document.getElementById("comments").style.display = "block";
                    loadComments();
                }
            }
            );
    </script>
</body>

</html>