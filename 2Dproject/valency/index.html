<html>
    <head>
        <title>化合价游戏-双人对局</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body, html {
                margin: 0;
                padding: 0;
                overflow: hidden;
                height: 100%;
                width: 100%;
                touch-action: manipulation;
            }
            #game {
                display: block;
            }
        </style>
        <script type="application/json" id="elementData">
            {
                "element":[
                    {
                        "name":"钠",
                        "valency":[1],
                        "type":"金属离子"
                    },
                    {
                        "name":"氯",
                        "valency":[-1, 1, 3, 5, 7],
                        "type":"非金属离子"
                    },{
                        "name":"铁",
                        "valency":[2,3],
                        "type":"金属离子"
                    },{
                        "name":"铜",
                        "valency":[1,2],
                        "type":"金属离子"
                    },
                    {
                        "name":"钙",
                        "valency":[2],
                        "type":"金属离子"
                    },
                    {
                        "name":"氧",
                        "valency":[-2],
                        "type":"非金属离子"
                    },
                    {
                        "name":"铝",
                        "valency":[3],
                        "type":"金属离子"
                    },
                    {
                        "name":"硫",
                        "valency":[-2],
                        "type":"非金属离子"
                    },
                    {
                        "name":"镁",
                        "valency":[2],
                        "type":"金属离子"
                    },
                    {
                        "name":"氮",
                        "valency":[-3],
                        "type":"非金属离子"
                    },{
                        "name":"碳",
                        "valency":[4,2],
                        "type":"非金属离子"
                    },
                    {
                        "name":"钾",
                        "valency":[1],
                        "type":"金属离子"
                    },
                    {
                        "name":"氟",
                        "valency":[-1],
                        "type":"非金属离子"
                    },{
                        "name":"氢氧根",
                        "valency":[-1],
                        "type":"原子团"
                    },{
                        "name":"硫酸根",
                        "valency":[-2],
                        "type":"原子团"
                    },
                    {
                        "name":"碳酸根",
                        "valency":[-2],
                        "type":"原子团"
                    },{
                        "name":"铵根",
                        "valency":[1],
                        "type":"原子团"
                    },{
                        "name":"磷酸根",
                        "valency":[-3],
                        "type":"原子团"
                    },{
                        "name":"硝酸根",
                        "valency":[-1],
                        "type":"原子团"
                    }
                ]
            }
        </script>
    </head>
    <body>
        <canvas id="game"></canvas>
        <script>
            const raw = document.getElementById("elementData").textContent;
            const data = JSON.parse(raw);

            console.log(data.element);

            document.addEventListener('wheel', function(event) {
                event.preventDefault()
            }, { passive: false });//禁止页面缩放
            var dpr=1;
            function resizeCanvas() {
                const canvas = document.getElementById('game');
                dpr = window.devicePixelRatio || 1;
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                canvas.width = window.innerWidth * dpr;
                canvas.height = window.innerHeight * dpr;
                const ctx = canvas.getContext('2d');
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            //initialize game
            const canvas = document.getElementById('game');
            const ctx = canvas.getContext('2d');

            const activePointers = new Map();

            canvas.addEventListener('pointerdown', (event) => {
                activePointers.set(event.pointerId, { x: event.clientX, y: event.clientY });
            });
            canvas.addEventListener('pointerup', (event) => {
                activePointers.delete(event.pointerId);
            });
            canvas.addEventListener('pointermove', (event) => {
                if (activePointers.has(event.pointerId)) {
                    activePointers.set(event.pointerId, { x: event.clientX, y: event.clientY });
                }
            });
            canvas.addEventListener('pointercancel', (event) => {
                activePointers.delete(event.pointerId);
            });

            let playBluePuzzle = {};
            let playRedPuzzle = {};
            let blueUsedElements = [], redUsedElements = [];
            function initPuzzle() {
                for(let i=0;i<4;i++){
                    playBluePuzzle[i]=[];
                    playRedPuzzle[i]=[];
                    for(let j=0;j<4;j++){
                        playBluePuzzle[i][j]=null;
                        playRedPuzzle[i][j]=null;
                    }
                }
                
                for(let i=0;i<4;i++){
                    for(let j=0;j<4;j++){
                        let index = Math.floor(Math.random() * data.element.length);
                        if(blueUsedElements.includes(index)){
                            while(blueUsedElements.includes(index)){
                                index = Math.floor(Math.random() * data.element.length);
                            }
                        }
                        blueUsedElements.push(index);
                        playBluePuzzle[i][j] = data.element[index];
                        index = Math.floor(Math.random() * data.element.length);
                        if(redUsedElements.includes(index)){
                            while(redUsedElements.includes(index)){
                                index = Math.floor(Math.random() * data.element.length);
                            }
                        }
                        playRedPuzzle[i][j] = data.element[index];
                        console.log(playBluePuzzle[i][j]);
                        console.log(playRedPuzzle[i][j]);
                    }
                }
            }

            initPuzzle();

            let buttonCollisons = [];

            function update() {
                for (const [id, pointer] of activePointers) {
                    // Handle pointer movement

                }
            }

            function render() {
                
                ctx.fillStyle = '#eff3f7';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'black';
                ctx.font = '30px Arial';
                ctx.textAlign="center"; 
                const width = canvas.width / dpr;
                const height = canvas.height / dpr;
                ctx.fillText('化合价', width / 2, 30);

                ctx.fillStyle = 'blue';
                ctx.fillText('蓝方玩家', width / 4, 100);
                ctx.fillStyle = 'red';
                ctx.fillText('红方玩家', (width / 4) * 3, 100);

                function drawRoundRect(x, y, width, height, radius, lineWidth=2) {
                    x+=lineWidth/2;
                    y+=lineWidth/2;
                    width-=lineWidth;
                    height-=lineWidth;
                    ctx.lineWidth = lineWidth;
                    ctx.beginPath();
                    ctx.moveTo(x + radius, y);
                    ctx.lineTo(x + width - radius, y);
                    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                    ctx.lineTo(x + width, y + height - radius);
                    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                    ctx.lineTo(x + radius, y + height);
                    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                    ctx.lineTo(x, y + radius);
                    ctx.quadraticCurveTo(x, y, x + radius, y);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                }
                ctx.fillStyle = '#dedede';
                ctx.strokeStyle = 'gray';
                
                drawRoundRect(0, 150, width / 2 - 10, height-200, 20, 5);
                drawRoundRect(width / 2 + 5 , 150, width / 2 - 10, height-200, 20, 5);

                const buttonWidth = width / 8 - 20;
                const buttonHeight = (height - 200) / 4 - 20;
                ctx.fillStyle = 'lightgreen';

                for(var i=0;i<4;i++){
                    for(var j=0;j<4;j++){
                        const x = 20 + i * (buttonWidth + 10);
                        const y = 170 + j * (buttonHeight + 10);
                        ctx.strokeStyle = '#4CAF50';
                        ctx.fillStyle = '#2FD057';
                        drawRoundRect(x, y, buttonWidth, buttonHeight, 10, 3);
                        ctx.fillStyle = 'black';
                        let text = playBluePuzzle[i][j].name;
                        const btnSize = Math.min(buttonHeight, buttonWidth) - 5;
                        let fontSize = (btnSize) / text.length;
                        ctx.font = `${fontSize}px Arial`;
                        let textWidth = ctx.measureText(text).width;
                        while (fontSize > btnSize *0.35 ) {
                            fontSize -= 1;
                            ctx.font = `${fontSize}px Arial`;
                            textWidth = ctx.measureText(text).width;
                        }
                        ctx.fillText(playBluePuzzle[i][j].name, x + buttonWidth / 2, y + buttonHeight / 2 );
                        text = playBluePuzzle[i][j].type;
                        fontSize = (btnSize) / text.length / 2;
                        ctx.font = `${fontSize}px Arial`;
                        ctx.fillText(playBluePuzzle[i][j].type, x + buttonWidth / 2, y + buttonHeight / 2 + buttonHeight / 3);
                        ctx.fillStyle = '#4CAF50';

                        buttonCollisons.push({x, y, width: buttonWidth, height: buttonHeight, player: 'blue', row: i, col: j});
                    }
                }

                for(let i=0;i<4;i++){
                    for(let j=0;j<4;j++){
                        const x = width / 2 + 25 + i * (buttonWidth + 10);
                        const y = 170 + j * (buttonHeight + 10);
                        ctx.strokeStyle = '#F44336';
                        ctx.fillStyle = '#FF5733';
                        drawRoundRect(x, y, buttonWidth, buttonHeight, 10, 3);
                        ctx.fillStyle = 'black';
                        let text = playRedPuzzle[i][j].name;
                        const btnSize = Math.min(buttonHeight, buttonWidth) - 5;
                        let fontSize = (btnSize) / text.length;
                        ctx.font = `${fontSize}px Arial`;
                        let textWidth = ctx.measureText(text).width;
                        while (fontSize > btnSize *0.35 ) {
                            fontSize -= 1;
                            ctx.font = `${fontSize}px Arial`;
                            textWidth = ctx.measureText(text).width;
                        }
                        ctx.fillText(playRedPuzzle[i][j].name, x + buttonWidth / 2, y + buttonHeight / 2 );
                        text = playRedPuzzle[i][j].type;
                        fontSize = (btnSize) / text.length / 2;
                        ctx.font = `${fontSize}px Arial`;
                        ctx.fillText(playRedPuzzle[i][j].type, x + buttonWidth / 2, y + buttonHeight / 2 + buttonHeight / 3);
                        ctx.fillStyle = '#F44336';

                        buttonCollisons.push({x, y, width: buttonWidth, height: buttonHeight, player: 'red', row: i, col: j});
                    }
                }
            }

            function loop() {
                render();
                requestAnimationFrame(loop);
            }

            loop();
        </script>
    </body>
</html>