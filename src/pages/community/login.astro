---
import Head from "../../components/Head.astro";
---
<html>
    <head>
        <Head enableMath enableHighlight/>
        <title>登录 - Songlll</title>
    </head>
    <body>
        <h1>正在开发ing</h1>
        <h1>登录页面</h1>
        <form action="" id="loginForm" method="POST">
            <label for="username">用户名:</label>
            <input type="text" id="username" name="username" required />
            <br />
            <label for="password">密码:</label>
            <input type="password" id="password" name="password" required />
            <br />
            <button type="submit">登录</button>
        </form>
        <script>
            async function fetchWithTimeout(resource: string | URL | Request, options = {timeout: 8000}) {
                const { timeout } = options;
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);

                try {
                const response = await fetch(resource, {
                ...options,
                signal: controller.signal
                });
                return response;
                } finally {
                clearTimeout(id);
                }
            }
            async function test(url: string | URL | Request) {
                try {
                    const res = await fetchWithTimeout(url,{timeout: 1000});
                    return true;
                } catch (e: any) {
                    if(404 === e?.status) {
                        return true;
                    }
                    console.error(e?.status);
                    return false;
                }
            }

            const baseDiscussUrl = await test("https://songllluv-edgemockser-41.deno.dev/ping")?"https://songllluv-edgemockser-41.deno.dev/":"https://ljrfkrxwkqnruheucstl.supabase.co/functions/v1/songlllEdgeService/";

            document.getElementById("loginForm")?.addEventListener("submit", function(e) {
                e.preventDefault();
                const form = e.target as HTMLFormElement;
                const formData = new FormData(form);
                const data = {
                    username: formData.get("username"),
                    password: formData.get("password")
                };

                fetch(baseDiscussUrl + "login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Success:", data);
                    alert("登录成功！");
                    localStorage.setItem("token", data.token);
                    window.location.href = "/community";
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("登录失败！");
                });
            });
        </script>
    </body>
</html>